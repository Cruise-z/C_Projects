#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include "hexdump.h"
#include "sm2.h"


#if 0
######################################
x86: CPU 2.8G
sm2_sign speed:147.058824/s
sm2_verify speed:116.414435/s
sm2_verify OK!===0
sm2_encrypt speed:74.404762/s
sm2_decrypt speed:150.602410/s
sm2_decrypt OK!

######################################

#endif

void key_test()
{
        unsigned char ida[19] = "ALICE123@YAHOO.COM";
        unsigned char idb[18] = "BILL456@YAHOO.COM";
        unsigned char da[] = {0x6F,0xCB,0xA2,0xEF,0x9A,0xE0,0xAB,0x90,0x2B,0xC3,0xBD,0xE3,0xFF,0x91,0x5D,0x44,0xBA,0x4C,0xC7,0x8F,0x88,0xE2,0xF8,0xE7,0xF8,0x99,0x6D,0x3B,0x8C,0xCE,0xED,0xEE}; 
        unsigned char xa[] = {0x30,0x99,0x09,0x3B,0xF3,0xC1,0x37,0xD8,0xFC,0xBB,0xCD,0xF4,0xA2,0xAE,0x50,0xF3,0xB0,0xF2,0x16,0xC3,0x12,0x2D,0x79,0x42,0x5F,0xE0,0x3A,0x45,0xDB,0xFE,0x16,0x55};
        unsigned char ya[] = {0x3D,0xF7,0x9E,0x8D,0xAC,0x1C,0xF0,0xEC,0xBA,0xA2,0xF2,0xB4,0x9D,0x51,0xA4,0xB3,0x87,0xF2,0xEF,0xAF,0x48,0x23,0x39,0x08,0x6A,0x27,0xA8,0xE0,0x5B,0xAE,0xD9,0x8B};
        unsigned char db[] = {0x5E,0x35,0xD7,0xD3,0xF3,0xC5,0x4D,0xBA,0xC7,0x2E,0x61,0x81,0x9E,0x73,0x0B,0x01,0x9A,0x84,0x20,0x8C,0xA3,0xA3,0x5E,0x4C,0x2E,0x35,0x3D,0xFC,0xCB,0x2A,0x3B,0x53}; 
        unsigned char xb[] = {0x24,0x54,0x93,0xD4,0x46,0xC3,0x8D,0x8C,0xC0,0xF1,0x18,0x37,0x46,0x90,0xE7,0xDF,0x63,0x3A,0x8A,0x4B,0xFB,0x33,0x29,0xB5,0xEC,0xE6,0x04,0xB2,0xB4,0xF3,0x7F,0x43};
        unsigned char yb[] = {0x53,0xC0,0x86,0x9F,0x4B,0x9E,0x17,0x77,0x3D,0xE6,0x8F,0xEC,0x45,0xE1,0x49,0x04,0xE0,0xDE,0xA4,0x5B,0xF6,0xCE,0xCF,0x99,0x18,0xC8,0x5E,0xA0,0x47,0xC6,0x0A,0x4C};

        unsigned char kabuf[32], sa[32];
        unsigned char kbbuf[32], sb[32], s1[32], s2[32];
        unsigned char kx2[32], ky2[32];
        int kx2len, ky2len;
        unsigned char kx1[256], ky1[256], ra[256], xv[32], yv[32];
        int kx1len,ky1len, ralen, xvlen, yvlen;

#if SM2_DEBUG
#else
        sm2_keygen(xa, &kx1len, ya, &ky1len, da, &ralen);
        sm2_keygen(xb, &kx1len, yb, &ky1len, db, &ralen);
#endif

        sm2_keyagreement_a1_3(kx1, &kx1len, ky1, &ky1len, ra, &ralen);

        sm2_keyagreement_b1_9(
                                                  kx1, kx1len,
                                                  ky1, ky1len,
                                                  xa, 32,
                                                  ya, 32,
                                                  db, 32,
                                                  xb, 32,
                                                  yb, 32,
                                                  ida, 18,
                                                  idb, 17,
                                                  16,
                                                  kbbuf,
                                                  kx2, &kx2len,
                                                  ky2, &ky2len,
                                                  xv, &xvlen,
                                                  yv, &yvlen,
                                                  sb
                                                  );


        sm2_keyagreement_a4_10(
                                                  kx1, kx1len,
                                                  ky1, ky1len,
                                                  xa, 32,
                                                  ya, 32,
                                                  da, 32,
                                                  xb, 32,
                                                  yb, 32,
                                                  ida, 18,
                                                  idb, 17,
                                                  kx2, kx2len,
                                                  ky2, ky2len,
                                                  ra, ralen,
                                                  16,
                                                  kabuf,
                                                  s1,
                                                  sa
                                                  );

        sm2_keyagreement_b10(
                                                  xa, 32,
                                                  ya, 32,
                                                  xb, 32,
                                                  yb, 32,
                                                  kx1, 32,
                                                  ky1, 32,
                                                  kx2, 32,
                                                  ky2, 32,
                                                  xv, xvlen,
                                                  yv, yvlen,
                                                  ida, 18,
                                                  idb, 17,
                                                  s2
                );

        if(memcmp(s1, sb, 32) != 0)
        {
                printf("key_test error ! \n");
                return;
        }
        if(memcmp(kabuf, kbbuf, 16) != 0)
        {
                printf("key_test error ! \n");
                return;
        }

        if(memcmp(s2, sa, 32) != 0)
        {
                printf("key_test error ! \n");
                return;
        }

        printf("key_test OK ! \n");


}
#if 1
int main(int arc, char *argv[])
{
	int rlen, slen, rv;
/*
	unsigned char digest_sm2[] = {0xB5,0x24,0xF5,0x52,0xCD,0x82,0xB8,0xB0,0x28,0x47,0x6E,0x00,0x5C,0x37,0x7F,0xB1,0x9A,0x87,0xE6,0xFC,0x68,0x2D,0x48,0xBB,0x5D,0x42,0xE3,0xD9,0xB9,0xEF,0xFE,0x76};
	unsigned char kA_sm2[] = {0x12,0x8B,0x2F,0xA8,0xBD,0x43,0x3C,0x6C,0x06,0x8C,0x8D,0x80,0x3D,0xFF,0x79,0x79,0x2A,0x51,0x9A,0x55,0x17,0x1B,0x1B,0x65,0x0C,0x23,0x66,0x1D,0x15,0x89,0x72,0x63}; 
	unsigned char kAx_sm2[] = {0x0A,0xE4,0xC7,0x79,0x8A,0xA0,0xF1,0x19,0x47,0x1B,0xEE,0x11,0x82,0x5B,0xE4,0x62,0x02,0xBB,0x79,0xE2,0xA5,0x84,0x44,0x95,0xE9,0x7C,0x04,0xFF,0x4D,0xF2,0x54,0x8A};
	unsigned char kAy_sm2[] = {0x7C,0x02,0x40,0xF8,0x8F,0x1C,0xD4,0xE1,0x63,0x52,0xA7,0x3C,0x17,0xB7,0xF1,0x6F,0x07,0x35,0x3E,0x53,0xA1,0x76,0xD6,0x84,0xA9,0xFE,0x0C,0x6B,0xB7,0x98,0xE8,0x57};
	unsigned char r_sm2[] = {0x40,0xF1,0xEC,0x59,0xF7,0x93,0xD9,0xF4,0x9E,0x09,0xDC,0xEF,0x49,0x13,0x0D,0x41,0x94,0xF7,0x9F,0xB1,0xEE,0xD2,0xCA,0xA5,0x5B,0xAC,0xDB,0x49,0xC4,0xE7,0x55,0xD1};
	unsigned char s_sm2[] = {0x6F,0xC6,0xDA,0xC3,0x2C,0x5D,0x5C,0xF1,0x0C,0x77,0xDF,0xB2,0x0F,0x7C,0x2E,0xB6,0x67,0xA4,0x57,0x87,0x2F,0xB0,0x9E,0xC5,0x63,0x27,0xA6,0x7E,0xC7,0xDE,0xEB,0xE7};
	
	
	unsigned char dB[] = {0x16,0x49,0xAB,0x77,0xA0,0x06,0x37,0xBD,0x5E,0x2E,0xFE,0x28,0x3F,0xBF,0x35,0x35,0x34,0xAA,0x7F,0x7C,0xB8,0x94,0x63,0xF2,0x08,0xDD,0xBC,0x29,0x20,0xBB,0x0D,0xA0}; 
	unsigned char xB[] = {0x43,0x5B,0x39,0xCC,0xA8,0xF3,0xB5,0x08,0xC1,0x48,0x8A,0xFC,0x67,0xBE,0x49,0x1A,0x0F,0x7B,0xA0,0x7E,0x58,0x1A,0x0E,0x48,0x49,0xA5,0xCF,0x70,0x62,0x8A,0x7E,0x0A};
	unsigned char yB[] = {0x75,0xDD,0xBA,0x78,0xF1,0x5F,0xEE,0xCB,0x4C,0x78,0x95,0xE2,0xC1,0xCD,0xF5,0xFE,0x01,0xDE,0xBB,0x2C,0xDB,0xAD,0xF4,0x53,0x99,0xCC,0xF7,0x7B,0xBA,0x07,0x6A,0x42};
	unsigned char tx[] = "encryption standard";
*/

	unsigned char digest_sm2[] = {0x38,0x54,0xC4,0x63,0xFA,0x3F,0x73,0x78,0x36,0x21,0xB1,0xCE,0x4E,0xF8,0x3F,0x7C,0x78,0x04,0x8A,0xAC,0x79,0xB2,0x21,0xFC,0xDD,0x29,0x08,0x66,0xCC,0x13,0x11,0x74};
	unsigned char kA_sm2[] = {0xC2,0x42,0x93,0x9D,0xDA,0xB6,0xFC,0xC0,0x7B,0x66,0x76,0xC0,0x7D,0x2D,0xC1,0x17,0xEC,0x68,0xA0,0x91,0x42,0xC2,0x5C,0x00,0x86,0x30,0xB9,0x75,0x67,0x86,0x16,0x2D}; 
	unsigned char kAx_sm2[] = {0x5C,0xA4,0xE4,0x40,0xC5,0x08,0xC4,0x5F,0xE7,0xD7,0x58,0xAB,0x10,0xC4,0x5D,0x82,0x37,0xC4,0xF9,0x55,0x9F,0x7D,0x46,0x61,0x85,0xF2,0x95,0x39,0x9F,0x0A,0xA3,0x7D};
	unsigned char kAy_sm2[] = {0x59,0xAD,0x8A,0x3C,0xD1,0x79,0x03,0x28,0x76,0x81,0xBF,0x9D,0x21,0xDA,0x2E,0xB3,0x16,0xA0,0xCE,0x8F,0xD4,0x1C,0x89,0xCE,0x1E,0x2B,0x3F,0x1B,0x8E,0x04,0x1A,0xBA};
	unsigned char r_sm2[] = {0x6E,0x5D,0xB4,0x9D,0xBD,0x09,0x92,0xB9,0x70,0x40,0x08,0x0A,0x96,0x00,0x3C,0x72,0x1C,0xDB,0x9C,0xF6,0x4C,0x88,0xD7,0x43,0x21,0xFC,0x2F,0x63,0x0A,0xDF,0x37,0x74};
	unsigned char s_sm2[] = {0x2F,0x6D,0xFF,0x45,0x3D,0xFC,0x8D,0x7A,0x50,0x6D,0x3F,0x52,0x30,0x1B,0xEE,0x52,0x9E,0x62,0xFD,0xDD,0x38,0x94,0x8F,0x0D,0x5D,0x2C,0xBC,0xBC,0x55,0x90,0x0C,0xFA};
	
	unsigned char dB[] = {0x9E,0xD4,0x5E,0x25,0x82,0x6B,0x67,0xE8,0xAC,0xCD,0x63,0xD3,0xE1,0x60,0x51,0x79,0xCF,0x41,0x7E,0x2A,0xDB,0x39,0x13,0x61,0xCD,0xBF,0x36,0x7E,0xC1,0x68,0x7E,0xCE}; 
	unsigned char xB[] = {0xF6,0xD3,0x26,0x50,0x9B,0xA8,0xDA,0x09,0xAA,0x34,0xCD,0x85,0xAE,0xF7,0x9D,0xBA,0x45,0xFD,0x17,0xE6,0x75,0x54,0x1B,0x15,0xEF,0x5E,0xC9,0xB8,0xF4,0xAB,0x18,0xBC};
	unsigned char yB[] = {0xA1,0x3A,0x2F,0x04,0xC6,0xBC,0x16,0x07,0xCA,0x72,0xCC,0x29,0x6A,0x9A,0xCF,0x7B,0xF2,0x68,0x91,0xC3,0x2B,0x21,0x0B,0x94,0x7C,0xA8,0x8F,0x3B,0x92,0x80,0x1E,0x8F};
	unsigned char tx[] = "encryption standard";
	unsigned char etx[256] ;
	unsigned char mtx[256] ;
         int etx_len, mtx_len;
	
	clock_t start,end;
	double tt;
	int j;

//	unsigned char userid[] = "ALICE123@YAHOO.COM";
//	unsigned char msg[] = "message digest";

//	key_test();
	int loop = 200;

//	sm2_keygen(kAx_sm2, &wxlen, kAy_sm2, &wylen, kA_sm2, &privkeylen);
//	sm2_keygen(xB, &wxlen, yB, &wylen, dB, &privkeylen);


	start = clock();

	for(j=0;j<loop;j++)
		sm2_sign(digest_sm2,32,kA_sm2,32,r_sm2,&rlen,s_sm2,&slen);

	end = clock();

	tt = (double)(end-start)/CLOCKS_PER_SEC;
	printf("sm2_sign speed:%lf/s\n", (double)j/tt);

	start = clock();

	for(j=0;j<loop;j++)
		rv = sm2_verify(digest_sm2,32,r_sm2,32,s_sm2,32,kAx_sm2,32,kAy_sm2,32);

	end = clock();
	tt = (double)(end-start)/CLOCKS_PER_SEC;
	printf("sm2_verify speed:%lf/s\n", (double)j/tt);

	if(rv != 0) 
		printf("sm2_verify error!===%d\n",rv);
	else
		printf("sm2_verify OK!===%d\n",rv);
	
	
	start = clock();

	for(j=0;j<loop;j++)
		sm2_encrypt(tx,19,xB,32,yB,32,etx, &etx_len);

	end = clock();
	tt = (double)(end-start)/CLOCKS_PER_SEC;
	printf("sm2_encrypt speed:%lf/s\n", (double)j/tt);



	start = clock();
	for(j=0;j<loop;j++)
		sm2_decrypt(etx,64+19+32,dB,32,mtx, &mtx_len);
	end = clock();
	tt = (double)(end-start)/CLOCKS_PER_SEC;
	printf("sm2_decrypt speed:%lf/s\n", (double)j/tt);

	if(sm2_decrypt(etx,64+19+32,dB,32,mtx, &mtx_len) < 0)
		printf("sm2_decrypt error!\n");
	else
		printf("sm2_decrypt OK!\n");
	

	return 0;

}

#else

int main(int arc, char *argv[])
{
#if 0
	unsigned char pubKey_x[32],pubKey_y[32];
	unsigned char privkey[32];
	int pubKey_x_len,pubKey_y_len,privkeylen;
	int i;

	unsigned char hash[32];
	unsigned char userid[8]={0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08};
	unsigned char data[]={"1234567812345678"};
	unsigned char  sign_r[32] = {0};
	int    sign_r_len;
	unsigned char  sign_s[32] = {0};
	int    sign_s_len;
         int ret;

	sm2_keygen(pubKey_x,&pubKey_x_len,pubKey_y,&pubKey_y_len,privkey,&privkeylen);

	printf("pubKey_x = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",pubKey_x[i]);
	}
	printf("\npubKey_x_len = %d \n",pubKey_x_len);
    printf("***************************************************\n");

	printf("pubKey_y = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",pubKey_y[i]);
	}
	printf("\npubKey_y_len = %d \n",pubKey_y_len);
	printf("***************************************************\n");

	printf("privkey = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",privkey[i]);
	}
	printf("\nprivkeylen = %d \n",privkeylen);

	ret = sm3_e(userid,8,pubKey_x,32,pubKey_y,32,data,strlen((char *)data), hash);
         if (ret) {
	    printf("sm3_e error, ret = %d \n",ret);
         } else {
             printf("sm3_e ok, ret = %d \n",ret);
         }

	sm2_sign(hash,32, privkey,32, sign_r, &sign_r_len, sign_s, &sign_s_len);
	
	ret = sm2_verify(hash,32, sign_r, 32, sign_s,32, pubKey_x, 32, pubKey_y, 32);
         if (!ret) {
	    printf("sm2_verify success, ret = %d \n",ret);
         } else {
             printf("sm2_verify fail, ret = %d \n",ret);
         }
#endif

#if 0
	unsigned char pubKey_x[32],pubKey_y[32];
	unsigned char privkey[32];
	int pubKey_x_len,pubKey_y_len,privkeylen;
	int i;

	unsigned char tx[] = "encryption standard";
	unsigned char etx[256] ;
	unsigned char mtx[256] ;
         int etx_len, mtx_len;

	sm2_keygen(pubKey_x,&pubKey_x_len,pubKey_y,&pubKey_y_len,privkey,&privkeylen);

	printf("pubKey_x = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",pubKey_x[i]);
	}
	printf("\npubKey_x_len = %d \n",pubKey_x_len);
    printf("***************************************************\n");

	printf("pubKey_y = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",pubKey_y[i]);
	}
	printf("\npubKey_y_len = %d \n",pubKey_y_len);
	printf("***************************************************\n");

	printf("privkey = ");
	for(i=0;i<32;i++)
	{
		printf("%02X",privkey[i]);
	}
	printf("\nprivkeylen = %d \n",privkeylen);
	
	
	printf("text = %s\n", tx);
	memset(etx, 0, 256);
	memset(mtx, 0, 256);
	sm2_encrypt(tx,strlen((char *)tx),pubKey_x,32,pubKey_y,32,etx, &etx_len);

	printf("Encrypted: ");
	hexdump(etx, etx_len);


	if (sm2_decrypt(etx,64+19+32,privkey,32,mtx, &mtx_len) < 0) {
		printf("sm2_decrypt error!\n");
	} else {
		printf("sm2_decrypt OK!\n");
	}


	printf("des = %s\n", mtx);
	
	hexdump(mtx, mtx_len);
#endif

#if 1
    int ret;
    unsigned char hash[32] = {
        0x8A, 0x71, 0x8F, 0xC9, 0xB4, 0x93, 0x23, 0x70, 0x15, 0x1B, 0x96, 0xEA, 0xC8, 0xC4, 0xCE, 0x9D, 
        0x3C, 0xA7, 0x7C, 0xD5, 0xC2, 0x9C, 0x3C, 0x75, 0x11, 0xC7, 0xF0, 0xD9, 0x8C, 0x45, 0x03, 0x84
    };
    unsigned char privkey[32] = {
	0x43, 0x24, 0x20, 0xD9, 0x52, 0xC9, 0x6A, 0x64, 0x48, 0xAA, 0x02, 0x9B, 0x1B, 0x05, 0xF9, 0x02, 
	0x08, 0x04, 0x9F, 0xDD, 0xC1, 0xCF, 0x31, 0x4A, 0xBE, 0xC5, 0x31, 0x9F, 0x11, 0x72, 0xFA, 0xD3
    };
    
    unsigned char pubKey_x[32] = {
        0x05, 0xC9, 0xFB, 0x4D, 0x25, 0x82, 0x0D, 0x51, 0x70, 0x84, 0xF1, 0x28, 0xC2, 0x9D, 0xB0, 0x76,
        0xED, 0xF7, 0x34, 0x04, 0x84, 0x0F, 0xBD, 0x42, 0x17, 0x76, 0xF7, 0xEE, 0x30, 0x3B, 0x1B, 0x0C
    };
    unsigned char pubKey_y[32] = {
        0xA2, 0x7A, 0x69, 0x25, 0x1B, 0x7B, 0xBF, 0x1A, 0x7E, 0x43, 0x4D, 0x12, 0xFC, 0x7A, 0xDC, 0x35,
        0x2C, 0xE2, 0x4B, 0xDD, 0x5A, 0x80, 0x58, 0xFE, 0x4E, 0x81, 0xAA, 0x2F, 0x1F, 0xCF, 0xB6, 0x70
   };

    unsigned char sign_r[32] = {0};
    unsigned char sign_s[32] = {0};
     int r_len, s_len;

    sm2_sign(hash,32, privkey,32, sign_r, &r_len, sign_s, &s_len);
    printf("sign-r: %d bytes\n", r_len);
    hexdump(sign_r, r_len);
    printf(" \n");

    printf("sign-s: %d bytes\n", s_len);
    hexdump(sign_s, s_len);
    printf(" \n");

    ret = sm2_verify(hash,32, sign_r, 32, sign_s,32, pubKey_x, 32, pubKey_y, 32);
    if (!ret) {
        printf("sm2 verify Success!\n");
    } else {
        printf("sm2 verify Fail !\n");
    }
#endif

	return 0;
}
#endif




